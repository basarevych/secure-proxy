<html ng-app="App">
    <head>
        <title id="page-title"></title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="UTF-8">

        <link rel="stylesheet" href="/secure-proxy/static/bower_components/bootstrap/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="/secure-proxy/static/bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="/secure-proxy/static/auth/css/index.css">

        <script src="/secure-proxy/static/bower_components/jquery/dist/jquery.min.js"></script>
        <script src="/secure-proxy/static/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="/secure-proxy/static/bower_components/jquery.qrcode/dist/jquery.qrcode.min.js"></script>

        <script src="/secure-proxy/static/bower_components/cldrjs/dist/cldr.js"></script>
        <script src="/secure-proxy/static/bower_components/cldrjs/dist/cldr/event.js"></script>
        <script src="/secure-proxy/static/bower_components/cldrjs/dist/cldr/supplemental.js"></script>

        <script src="/secure-proxy/static/bower_components/globalize/dist/globalize.js"></script>
        <script src="/secure-proxy/static/bower_components/globalize/dist/globalize/message.js"></script>
        <script src="/secure-proxy/static/bower_components/globalize/dist/globalize/number.js"></script>
        <script src="/secure-proxy/static/bower_components/globalize/dist/globalize/plural.js"></script>
        <script src="/secure-proxy/static/bower_components/globalize/dist/globalize/currency.js"></script>
        <script src="/secure-proxy/static/bower_components/globalize/dist/globalize/date.js"></script>

        <script src="/secure-proxy/static/auth/js/globalizer.js"></script>
        <script src="/secure-proxy/static/auth/js/validator.js"></script>
        <script src="/secure-proxy/static/auth/js/handlers.js"></script>
    </head>
    <body>
        <div class="centered-wrapper">
            <div class="centered">
                <div id="password-form" class="col-xs-offset-1 col-xs-10 col-sm-offset-2 col-sm-8 col-md-offset-3 col-md-6">
                    <div class="localization">
                        <a class="language" href="javascript:setLocale('en')">
                            <img src="/secure-proxy/static/img/flags/en.gif"> en
                        </a>
                        <a class="language" href="javascript:setLocale('ru')">
                            <img src="/secure-proxy/static/img/flags/ru.gif"> ru
                        </a>
                    </div>
                    <form class="form-horizontal" onsubmit="return false">
                        <div id="password-messages"></div>

                        <div id="password-section">
                            <div class="form-group">
                                <div class="col-sm-offset-4 col-sm-8">
                                    <button id="submit-password-button" class="btn btn-default" type="submit" onclick="submitPassword()"></button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <script>
            var gl = null, currectLocale = null;
            var parts = window.location.toString().split('#');
            var secret = parts.length >= 2 && parts[1];

            function loadLocale(locale) {
                currentLocale = locale;

                var form = $('#login-form');
                if (form.css('display') != 'none')
                    form.hide();

                var promise = globalizer(
                    '/secure-proxy/static/bower_components/cldr-data',
                    '/secure-proxy/static/l10n',
                    locale
                );

                promise
                    .then(function (globalize) {
                        gl = window['globalize'] = globalize;
                        initPage();
                    });
            }

            function setLocale(locale) {
                $.ajax({
                    url: '/secure-proxy/api/locale',
                    data: {
                        set: locale,
                    },
                    success: function (data) {
                        loadLocale(data.locale);
                    }
                });
            }

            function initPage() {
                $('#page-title').text(gl.formatMessage('PAGE_TITLE'));
                $('#submit-password-button').text(gl.formatMessage('RESET_CODE_LABEL'));

                $('#password-section').show();
                $('#password-form').slideDown();
            }

            function submitPassword() {
                var messages = $('#password-messages');

                $.ajax({
                    url: '/secure-proxy/api/otp',
                    method: 'GET',
                    data: {
                        action: 'reset',
                        secret: secret,
                    },
                    success: function (data) {
                        messages.empty();

                        if (data.success) {
                            var msg = $('<div></div>');
                            msg.addClass('alert alert-success')
                               .text(gl.formatMessage('CODE_RESET_SUCCESS'))
                               .appendTo(messages);
                            $('#password-section').hide();
                        } else {
                            var expired = data.reason && data.reason == 'expired';
                            var msg = $('<div></div>');
                            msg.addClass('alert alert-danger')
                               .text(gl.formatMessage(expired ? 'PAGE_EXPIRED' : 'CODE_RESET_FAILURE'))
                               .appendTo(messages);
                        }
                    }
                });
            }

            $(document).ready(function () {
                $.getJSON('/secure-proxy/api/locale', function (data) {
                    loadLocale(data.locale);
                });
            });
        </script>
    </body>
</html>
